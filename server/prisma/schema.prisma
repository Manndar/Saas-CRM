generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPERADMIN
  USER
}

enum OrgRole {
  ADMIN
  MANAGER
  AGENT
  CUSTOMER
}

enum TicketStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Organization {
  id             String                @id @default(uuid()) @db.Uuid
  name           String
  slug           String                @unique
  members        OrganizationMember[]
  customers      Customer[]
  tickets        Ticket[]
  attachments    Attachment[]
  notifications  Notification[]
  comments       TicketComment[]
  refreshTokens  RefreshToken[]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

model User {
  id              String             @id @default(uuid()) @db.Uuid
  email           String             @unique
  passwordHash    String
  fullName        String
  globalRole      UserRole           @default(USER)
  memberships     OrganizationMember[]
  refreshTokens   RefreshToken[]
  createdTickets  Ticket[]           @relation("TicketCreatedBy")
  assignedTickets Ticket[]           @relation("TicketAssignedTo")
  comments        TicketComment[]
  attachments     Attachment[]
  notifications   Notification[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model OrganizationMember {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @db.Uuid
  organizationId String        @db.Uuid
  role           OrgRole
  title          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

model RefreshToken {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @db.Uuid
  organizationId String?       @db.Uuid
  hashedToken    String
  expiresAt      DateTime
  revokedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
}

model Customer {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @db.Uuid
  name           String
  email          String
  phone          String?
  company        String?
  tickets        Ticket[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
}

model Ticket {
  id               String           @id @default(uuid()) @db.Uuid
  organizationId   String           @db.Uuid
  title            String
  description      String?
  status           TicketStatus     @default(OPEN)
  priority         TicketPriority   @default(MEDIUM)
  customerId       String?          @db.Uuid
  createdById      String           @db.Uuid
  assigneeId       String?          @db.Uuid
  dueAt            DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer         Customer?        @relation(fields: [customerId], references: [id], onDelete: SetNull)
  createdBy        User             @relation("TicketCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  assignee         User?            @relation("TicketAssignedTo", fields: [assigneeId], references: [id], onDelete: SetNull)
  comments         TicketComment[]
  attachments      Attachment[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, customerId])
}

model TicketComment {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @db.Uuid
  ticketId       String        @db.Uuid
  authorId       String        @db.Uuid
  body           String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticket         Ticket        @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author         User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  attachments    Attachment[]

  @@index([organizationId])
  @@index([ticketId])
}

model Attachment {
  id             String         @id @default(uuid()) @db.Uuid
  organizationId String         @db.Uuid
  ticketId       String         @db.Uuid
  commentId      String?        @db.Uuid
  uploadedById   String         @db.Uuid
  filename       String
  mimetype       String
  size           Int
  s3Key          String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticket         Ticket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  comment        TicketComment? @relation(fields: [commentId], references: [id], onDelete: SetNull)
  uploadedBy     User           @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([ticketId])
}

model Notification {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @db.Uuid
  userId         String        @db.Uuid
  type           String
  payload        Json?
  readAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
}
